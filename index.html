<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gedeon - Location Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      margin-top: 40px;
      max-width: 600px;
      width: 100%;
      background: #020617;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      border: 1px solid #1f2937;
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      margin-bottom: 4px;
    }

    h2 {
      font-size: 1.1rem;
      margin-top: 24px;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .client-id {
      font-family: "Fira Code", monospace;
      font-size: 0.75rem;
      word-break: break-all;
      background: #020617;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #1f2937;
      margin-bottom: 12px;
    }

    button {
      background: #1d4ed8;
      border: none;
      color: #e5e7eb;
      padding: 10px 16px;
      font-size: 0.9rem;
      border-radius: 999px;
      cursor: pointer;
      margin: 4px 4px 8px 0;
    }

    button.secondary {
      background: #374151;
    }

    button.danger {
      background: #b91c1c;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      font-size: 0.85rem;
      margin-top: 8px;
      color: #9ca3af;
      white-space: pre-line;
    }

    .log {
      margin-top: 12px;
      padding: 8px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #1f2937;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #0b1120;
      border: 1px solid #1f2937;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    a {
      color: #60a5fa;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Gedeon - Tracker</h1>
  <div class="subtitle">
    Suivi de localisation simple, avec un identifiant unique par navigateur (client_id).
  </div>

  <div class="badge">
    <span class="dot"></span>
    <span id="server-url"></span>
  </div>

  <h2>Client ID (navigateur)</h2>
  <div class="client-id" id="client-id">‚Äì</div>

  <h2>Actions</h2>
  <div>
    <button id="btn-send-once">üìç Envoyer une position</button>
    <button id="btn-start">‚ñ∂Ô∏è Start tracking</button>
    <button id="btn-stop" class="secondary" disabled>‚è∏ Stop tracking</button>
    <button id="btn-latest" class="secondary">üîé Derni√®re position</button>
    <button id="btn-clear" class="danger">üßπ Clear MES positions</button>
  </div>

  <div class="status" id="status">Pr√™t.</div>

  <h2>Log</h2>
  <div class="log" id="log"></div>

  <h2>API utiles</h2>
  <div class="status">
    - <code>GET /api/users</code> : liste des client_id et nombre de connexions<br>
    - <code>GET /api/locations</code> : toutes les positions<br>
    - <code>GET /api/location/latest</code> : derni√®re position<br>
    - <code>DELETE /api/locations/clear</code> : effacer les positions de CE client_id
  </div>
</div>

<script>
  const SERVER_URL = window.location.origin;

  // ---------------------------------------------------------------------------
  // Gestion du client_id (identifiant unique par navigateur / profil)
  // ---------------------------------------------------------------------------
  function getOrCreateClientId() {
    let id = localStorage.getItem('client_id');
    if (!id) {
      if (window.crypto && window.crypto.randomUUID) {
        id = window.crypto.randomUUID();
      } else {
        id = Math.random().toString(36).slice(2) + Date.now().toString(36);
      }
      localStorage.setItem('client_id', id);
      console.log('New client_id generated:', id);
    } else {
      console.log('Existing client_id:', id);
    }
    return id;
  }

  const CLIENT_ID = getOrCreateClientId();
  document.getElementById('client-id').textContent = CLIENT_ID;
  document.getElementById('server-url').textContent = SERVER_URL;

  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');

  function setStatus(text) {
    statusEl.textContent = text;
    console.log('[STATUS]', text);
  }

  function addLog(line) {
    const ts = new Date().toISOString();
    logEl.textContent = `[${ts}] ${line}\n` + logEl.textContent;
  }

  // ---------------------------------------------------------------------------
  // Ping serveur √† chaque ouverture de page
  // ---------------------------------------------------------------------------
  async function pingServer() {
    try {
      await fetch(`${SERVER_URL}/api/ping`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          client_id: CLIENT_ID,
          user_agent: navigator.userAgent
        })
      });
      addLog('Ping envoy√© au serveur.');
    } catch (e) {
      console.error('Ping error:', e);
      addLog('Erreur ping serveur: ' + e);
    }
  }

  window.addEventListener('load', pingServer);

  // ---------------------------------------------------------------------------
  // Envoi de la position
  // ---------------------------------------------------------------------------
  function getPosition(options = {}) {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        return reject(new Error("La g√©olocalisation n'est pas support√©e."));
      }
      navigator.geolocation.getCurrentPosition(resolve, reject, options);
    });
  }

  async function sendLocationOnce() {
    try {
      setStatus('Demande de position...');
      const pos = await getPosition({ enableHighAccuracy: true, timeout: 10000 });

      const payload = {
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude,
        accuracy: pos.coords.accuracy,
        client_id: CLIENT_ID
      };

      setStatus('Envoi de la position au serveur...');
      const res = await fetch(`${SERVER_URL}/api/location`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || 'Erreur HTTP');
      }

      setStatus('Position envoy√©e.');
      addLog(`Position envoy√©e: lat=${payload.latitude}, lon=${payload.longitude}, acc=${payload.accuracy}m`);
    } catch (e) {
      console.error(e);
      setStatus('Erreur: ' + e.message);
      addLog('Erreur position: ' + e.message);
    }
  }

  // ---------------------------------------------------------------------------
  // Tracking continu (intervalle)
  // ---------------------------------------------------------------------------
  let trackingInterval = null;

  function startTracking() {
    if (trackingInterval) return;
    setStatus('Tracking d√©marr√© (toutes les 30s)...');
    addLog('Tracking d√©marr√©.');
    trackingInterval = setInterval(sendLocationOnce, 30000);
    sendLocationOnce();
    document.getElementById('btn-start').disabled = true;
    document.getElementById('btn-stop').disabled = false;
  }

  function stopTracking() {
    if (trackingInterval) {
      clearInterval(trackingInterval);
      trackingInterval = null;
      setStatus('Tracking arr√™t√©.');
      addLog('Tracking arr√™t√©.');
      document.getElementById('btn-start').disabled = false;
      document.getElementById('btn-stop').disabled = true;
    }
  }

  // ---------------------------------------------------------------------------
  // R√©cup√©rer la derni√®re position
  // ---------------------------------------------------------------------------
  async function fetchLatest() {
    try {
      const res = await fetch(`${SERVER_URL}/api/location/latest`);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Erreur HTTP');

      if (!data.location) {
        setStatus(data.message || 'Aucune position enregistr√©e.');
        addLog('Pas de position.');
        return;
      }

      const loc = data.location;
      setStatus('Derni√®re position charg√©e.');
      addLog(`Derni√®re position: client_id=${loc.client_id} lat=${loc.latitude}, lon=${loc.longitude}, acc=${loc.accuracy}m`);
    } catch (e) {
      setStatus('Erreur: ' + e.message);
      addLog('Erreur /api/location/latest: ' + e.message);
    }
  }

  // ---------------------------------------------------------------------------
  // Effacer les positions du client courant uniquement
  // ---------------------------------------------------------------------------
  async function clearLocations() {
    if (!confirm('Effacer toutes MES positions (client_id courant) sur le serveur ?')) return;
    try {
      const res = await fetch(`${SERVER_URL}/api/locations/clear`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_id: CLIENT_ID })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Erreur HTTP');

      setStatus(data.message || 'Positions effac√©es pour ce client_id.');
      addLog(`Clear: ${data.removed ?? '?'} positions supprim√©es pour ce client_id.`);
    } catch (e) {
      setStatus('Erreur: ' + e.message);
      addLog('Erreur clear locations: ' + e.message);
    }
  }

  // ---------------------------------------------------------------------------
  // Wiring des boutons
  // ---------------------------------------------------------------------------
  document.getElementById('btn-send-once').addEventListener('click', sendLocationOnce);
  document.getElementById('btn-start').addEventListener('click', startTracking);
  document.getElementById('btn-stop').addEventListener('click', stopTracking);
  document.getElementById('btn-latest').addEventListener('click', fetchLatest);
  document.getElementById('btn-clear').addEventListener('click', clearLocations);
</script>
</body>
</html>
