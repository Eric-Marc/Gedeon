<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Localisation & √©v√©nements OpenAgenda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 26px;
            margin-bottom: 6px;
            color: #111827;
        }

        .subtitle {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 18px;
        }

        .status {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.waiting { background: #fef3c7; color: #92400e; }
        .status.active  { background: #d1fae5; color: #065f46; }
        .status.error   { background: #fee2e2; color: #991b1b; }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        button {
            flex: 1;
            min-width: 150px;
            border: none;
            border-radius: 10px;
            padding: 11px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary   { background: #4f46e5; color: #ffffff; }
        .btn-secondary { background: #10b981; color: #ffffff; }
        .btn-danger    { background: #ef4444; color: #ffffff; }

        .btn-primary:hover:not(:disabled) {
            background: #4338ca;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }

        /* üîî Animation de blink pour les boutons PENDANT le chargement */
        .btn-loading {
            animation: blinkButton 1s ease-in-out infinite;
        }

        @keyframes blinkButton {
            0%, 100% { opacity: 1; transform: translateY(0); }
            50%      { opacity: 0.4; transform: translateY(-1px); }
        }

        .section {
            background: #f9fafb;
            border-radius: 14px;
            padding: 14px 16px;
            margin-bottom: 14px;
        }

        .section h2 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #111827;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px 10px;
            font-size: 13px;
        }

        .info-label { color: #6b7280; }
        .info-value { color: #111827; font-family: monospace; text-align: right; }

        .map-container {
            margin-top: 9px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .map-container iframe {
            width: 100%;
            height: 260px;
            border: 0;
        }

        .map-link {
            display: inline-block;
            margin-top: 6px;
            font-size: 13px;
            text-decoration: none;
            color: #4f46e5;
            font-weight: 500;
        }

        .map-link:hover { text-decoration: underline; }

        .events-list {
            list-style: none;
            margin-top: 10px;
        }

        .event-item {
            background: #ffffff;
            border-radius: 10px;
            padding: 9px 11px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
        }

        .event-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #111827;
        }

        .event-meta {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .event-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 5px;
        }

        .event-link {
            font-size: 12px;
            text-decoration: none;
            color: #2563eb;
        }

        .event-link:hover {
            text-decoration: underline;
        }

        .events-map-container {
            width: 100%;
            height: 450px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            margin-top: 10px;
            margin-bottom: 16px;
        }

        .hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .slider-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }

        .slider-row label {
            font-size: 13px;
            color: #374151;
        }

        .slider-row input[type=range] {
            width: 100%;
        }

        @media (max-width: 640px) {
            .info-grid { grid-template-columns: 1fr; }
            .info-value { text-align: left; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üìç Localisation & √©v√©nements √† proximit√©</h1>
    <p class="subtitle">
        Le site utilise la position actuelle de ton t√©l√©phone pour afficher les √©v√©nements OpenAgenda
        en France enti√®re, filtr√©s par distance et par date.
    </p>

    <!-- Statut global -->
    <div id="status" class="status waiting">
        ‚è≥ En attente de la position du t√©l√©phone‚Ä¶
    </div>

    <!-- Boutons villes -->
    <div class="button-group">
        <button class="btn-secondary" onclick="onCityButtonClick('paris', this)">Paris</button>
        <button class="btn-secondary" onclick="onCityButtonClick('toulouse', this)">Toulouse</button>
    </div>

    <!-- Bouton bas√© sur la position r√©elle du t√©l√©phone -->
    <div class="button-group">
        <button class="btn-primary" onclick="onNearbyButtonClick(this)">√âv√©nements √† proximit√©</button>
    </div>

    <!-- Position actuelle (t√©l√©phone ou ville choisie) -->
    <div class="section" id="currentLocationSection" style="display:none;">
        <h2>Position actuelle (t√©l√©phone ou ville choisie)</h2>
        <div class="info-grid">
            <div class="info-label">Latitude</div>
            <div class="info-value" id="currentLatitude">-</div>

            <div class="info-label">Longitude</div>
            <div class="info-value" id="currentLongitude">-</div>

            <div class="info-label">Pr√©cision</div>
            <div class="info-value" id="currentAccuracy">-</div>

            <div class="info-label">Derni√®re mise √† jour</div>
            <div class="info-value" id="currentTimestamp">-</div>
        </div>
        <a id="currentMapLink" class="map-link" href="#" target="_blank" rel="noopener noreferrer">
            üìç Ouvrir cette position dans Google Maps
        </a>
    </div>

    <!-- √âv√©nements √† proximit√© -->
    <div class="section" id="eventsSection" style="display:none;">
        <h2>√âv√©nements √† proximit√©</h2>

        <!-- Curseurs de r√©glage -->
        <div class="slider-row">
            <label>
                Rayon : <strong><span id="radiusValue">30</span> km</strong>
            </label>
            <input type="range" id="radiusRange" min="10" max="1000" step="10" value="30">
        </div>

        <div class="slider-row">
            <label>
                Fen√™tre de temps : <strong>aujourd'hui + <span id="daysValue">2</span> jour(s)</strong>
            </label>
            <input type="range" id="daysRange" min="1" max="30" step="1" value="2">
        </div>

        <!-- r√©sum√© : nombre d'√©v√©nements trouv√©s -->
        <p id="eventsSummary"
           style="display:none; font-size:13px; color:#111827; font-weight:500; margin-bottom:6px;">
        </p>

        <p id="eventsEmpty" style="display:none; font-size:13px; color:#6b7280; margin-bottom:8px;">
            Aucun √©v√©nement trouv√© dans ce p√©rim√®tre pour la p√©riode choisie.
        </p>

        <!-- Carte unique pour tous les √©v√©nements -->
        <div id="eventsMap" class="events-map-container" style="display:none;"></div>

        <!-- liste des √©v√©nements trouv√©s -->
        <ul id="eventsList" class="events-list"></ul>

        <p class="hint">
            Chaque √©v√©nement affich√© poss√®de un lien vers OpenAgenda et Google&nbsp;Maps.
            La carte interactive ci-dessus affiche tous les √©v√©nements g√©olocalis√©s.
        </p>
    </div>
</div>

<script>
    const SERVER_URL = window.location.origin;

    // coordonn√©es fixes pour les villes
    const CITY_COORDS = {
        paris: {
            label: 'Paris',
            latitude: 48.8566,
            longitude: 2.3522
        },
        toulouse: {
            label: 'Toulouse',
            latitude: 43.6045,
            longitude: 1.4440
        }
    };

    // valeurs courantes des curseurs
    let currentRadiusKm = 30;
    let currentDays = 2;
    let currentPosition = null; // position actuelle (t√©l√©phone ou ville choisie)

    // contexte courant (null, 'Paris', 'Toulouse', 'GPS')
    let currentContextLabel = null;

    // bouton en cours de chargement
    let loadingButton = null;

    // timeout pour le debounce des sliders
    let sliderUpdateTimeout = null;
    const SLIDER_DEBOUNCE_MS = 600;

    // instance de la carte Leaflet
    let eventsMap = null;
    let eventsMarkers = [];
    let searchRadiusCircle = null;

    function updateStatus(message, type) {
        const div = document.getElementById('status');
        div.textContent = message;
        div.className = 'status ' + type;
    }

    function initOrResetEventsMap(centerLat, centerLon, radiusKm) {
        const mapDiv = document.getElementById('eventsMap');

        // Supprimer les anciens marqueurs
        eventsMarkers.forEach(marker => {
            if (eventsMap) {
                eventsMap.removeLayer(marker);
            }
        });
        eventsMarkers = [];

        // Supprimer l'ancien cercle de rayon
        if (searchRadiusCircle && eventsMap) {
            eventsMap.removeLayer(searchRadiusCircle);
        }

        // Si la carte n'existe pas encore, la cr√©er
        if (!eventsMap) {
            mapDiv.style.display = 'block';
            eventsMap = L.map('eventsMap').setView([centerLat, centerLon], 9);

            // Ajouter les tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(eventsMap);

            // Ajouter un contr√¥le d'√©chelle
            L.control.scale({
                metric: true,
                imperial: false,
                position: 'bottomleft'
            }).addTo(eventsMap);
        } else {
            // Recentrer la carte
            mapDiv.style.display = 'block';
            eventsMap.setView([centerLat, centerLon], 9);
        }

        // Ajouter un cercle montrant le rayon de recherche
        searchRadiusCircle = L.circle([centerLat, centerLon], {
            radius: radiusKm * 1000, // conversion km -> m√®tres
            color: '#4f46e5',
            fillColor: '#4f46e5',
            fillOpacity: 0.1,
            weight: 2
        }).addTo(eventsMap);

        return eventsMap;
    }

    function updateCurrentLocationDisplay(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const acc = position.coords.accuracy;

        document.getElementById('currentLatitude').textContent = lat.toFixed(6);
        document.getElementById('currentLongitude').textContent = lon.toFixed(6);
        document.getElementById('currentAccuracy').textContent =
            acc != null ? Math.round(acc) + ' m' : '-';
        document.getElementById('currentTimestamp').textContent =
            new Date().toLocaleString();

        const mapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
        document.getElementById('currentMapLink').href = mapsUrl;

        document.getElementById('currentLocationSection').style.display = 'block';
    }

    // Cr√©ation d'un "fake" objet position √† partir de coordonn√©es fixes
    function makeFakePosition(lat, lon) {
        return {
            coords: {
                latitude: lat,
                longitude: lon,
                accuracy: null
            }
        };
    }

    // Helper pour calculer "du ... au ..." √† partir d'aujourd'hui
    function getDateRangeTextFromNow(days) {
        const today = new Date();
        const end = new Date();
        end.setDate(today.getDate() + days);
        return {
            start: today.toLocaleDateString('fr-FR'),
            end: end.toLocaleDateString('fr-FR')
        };
    }

    // üîî Start / stop blink du bouton
    function startButtonLoading(buttonEl) {
        // enl√®ve le blink sur un ancien bouton au cas o√π
        if (loadingButton && loadingButton !== buttonEl) {
            loadingButton.classList.remove('btn-loading');
        }
        loadingButton = buttonEl;
        if (loadingButton) {
            loadingButton.classList.add('btn-loading');
        }
    }

    function stopButtonLoading() {
        if (loadingButton) {
            loadingButton.classList.remove('btn-loading');
            loadingButton = null;
        }
    }

    // Wrappers clics pour d√©clencher blink + logique
    function onCityButtonClick(cityKey, buttonEl) {
        startButtonLoading(buttonEl);
        fetchNearbyEventsForCity(cityKey)
            .finally(() => {
                stopButtonLoading();
            });
    }

    function onNearbyButtonClick(buttonEl) {
        startButtonLoading(buttonEl);
        fetchNearbyEventsWithCurrentPosition()
            .finally(() => {
                // la g√©oloc + fetch utilisent les callbacks, mais on stoppe ici au cas o√π
                stopButtonLoading();
            });
    }

    // üîπ Init : au d√©marrage on essaie d√©j√† d'obtenir la position
    function initGeolocationOnLoad() {
        if (!navigator.geolocation) {
            updateStatus('üî¥ G√©olocalisation non support√©e par ce navigateur', 'error');
            return;
        }

        updateStatus('üü° Recherche de la position du t√©l√©phone‚Ä¶', 'active');

        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentPosition = position;
                currentContextLabel = 'GPS';
                updateCurrentLocationDisplay(position);
                updateStatus('üü¢ Position trouv√©e. Tu peux maintenant chercher des √©v√©nements √† proximit√©.', 'active');
            },
            (error) => {
                console.error(error);
                updateStatus('üî¥ Erreur de g√©olocalisation : ' + error.message, 'error');
            },
            {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 10000
            }
        );
    }

    // üîπ Bouton "√âv√©nements √† proximit√©" = toujours position du t√©l√©phone (nouvelle g√©oloc)
    function fetchNearbyEventsWithCurrentPosition() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                updateStatus('üî¥ G√©olocalisation non support√©e par ce navigateur', 'error');
                reject(new Error('Geolocation not supported'));
                return;
            }

            updateStatus('üü° Recherche de la position du t√©l√©phone‚Ä¶', 'active');

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        currentPosition = position;
                        currentContextLabel = 'GPS';
                        updateCurrentLocationDisplay(position);
                        await fetchNearbyEvents(position);
                        resolve();
                    } catch (e) {
                        reject(e);
                    }
                },
                (error) => {
                    console.error(error);
                    updateStatus('üî¥ Erreur de g√©olocalisation : ' + error.message, 'error');
                    reject(error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                }
            );
        });
    }

    // üîπ Boutons Paris / Toulouse
    async function fetchNearbyEventsForCity(cityKey) {
        const city = CITY_COORDS[cityKey];
        if (!city) return;

        currentContextLabel = city.label;

        updateStatus(`üîç Recherche des √©v√©nements sur ${city.label}‚Ä¶`, 'active');

        const fakePos = makeFakePosition(city.latitude, city.longitude);
        currentPosition = fakePos;
        updateCurrentLocationDisplay(fakePos);

        await fetchNearbyEvents(fakePos);

        updateStatus(`üü¢ √âv√©nements charg√©s pour ${city.label}`, 'active');
    }

    async function fetchNearbyEvents(position) {
        try {
            if (!position) {
                updateStatus('üî¥ Position non disponible', 'error');
                return;
            }

            // Texte de lieu dans la phrase ("√† Paris", "√† Toulouse", "√† proximit√©")
            let placeText = '√† proximit√©';
            if (currentContextLabel === 'Paris') {
                placeText = '√† Paris';
            } else if (currentContextLabel === 'Toulouse') {
                placeText = '√† Toulouse';
            }

            const loadingRange = getDateRangeTextFromNow(currentDays);
            updateStatus(
                `üü° Chargement des √©v√©nements ${placeText} dans un rayon de ${currentRadiusKm} km, ` +
                `du ${loadingRange.start} au ${loadingRange.end}‚Ä¶`,
                'active'
            );

            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            const params = new URLSearchParams();
            params.append('lat', lat);
            params.append('lon', lon);
            params.append('radiusKm', currentRadiusKm);
            params.append('days', currentDays);

            const res = await fetch(`${SERVER_URL}/api/events/nearby?` + params.toString());
            const result = await res.json();

            console.log('DEBUG /api/events/nearby result:', result);

            const section = document.getElementById('eventsSection');
            const list = document.getElementById('eventsList');
            const empty = document.getElementById('eventsEmpty');
            const summary = document.getElementById('eventsSummary');
            const mapDiv = document.getElementById('eventsMap');

            list.innerHTML = '';
            empty.style.display = 'none';
            summary.style.display = 'none';
            mapDiv.style.display = 'none';

            if (!res.ok || result.status !== 'success') {
                section.style.display = 'block';
                empty.textContent = result.message || 'Erreur lors de la r√©cup√©ration des √©v√©nements.';
                empty.style.display = 'block';
                updateStatus('üî¥ Impossible de r√©cup√©rer les √©v√©nements', 'error');
                return;
            }

            const events = result.events || [];
            const radiusKm = result.radiusKm ?? currentRadiusKm;
            const days = result.days ?? currentDays;
            const count = result.count ?? events.length;

            const range = getDateRangeTextFromNow(days);

            if (events.length === 0) {
                section.style.display = 'block';
                empty.style.display = 'block';
                updateStatus(
                    `üü° Aucun √©v√©nement trouv√© ${placeText} dans un rayon de ${radiusKm} km, ` +
                    `du ${range.start} au ${range.end}`,
                    'waiting'
                );
                return;
            }

            // Initialiser la carte avec le centre de recherche et le rayon
            initOrResetEventsMap(lat, lon, radiusKm);

            summary.textContent =
                `${count} √©v√©nement(s) trouv√©(s) ${placeText} dans un rayon de ${radiusKm} km, ` +
                `du ${range.start} au ${range.end}.`;
            summary.style.display = 'block';

            events.forEach((ev, index) => {
                const li = document.createElement('li');
                li.className = 'event-item';

                const title = document.createElement('div');
                title.className = 'event-title';
                title.textContent = ev.title || '√âv√©nement sans titre';
                li.appendChild(title);

                const meta = document.createElement('div');
                meta.className = 'event-meta';

                const begin = ev.begin ? new Date(ev.begin).toLocaleString() : 'Date non pr√©cis√©e';

                const whereParts = [];
                if (ev.locationName) whereParts.push(ev.locationName);
                if (ev.address)      whereParts.push(ev.address);
                if (ev.city)         whereParts.push(ev.city);

                let metaText = `${begin} ‚Äî ${whereParts.join(' ¬∑ ') || 'Lieu non pr√©cis√©'}`;
                if (ev.distanceKm != null) {
                    metaText += ` ¬∑ ${ev.distanceKm} km`;
                }
                meta.textContent = metaText;
                li.appendChild(meta);

                const links = document.createElement('div');
                links.className = 'event-links';

                if (ev.openagendaUrl) {
                    const oaLink = document.createElement('a');
                    oaLink.className = 'event-link';
                    oaLink.href = ev.openagendaUrl;
                    oaLink.target = '_blank';
                    oaLink.rel = 'noopener noreferrer';
                    oaLink.textContent = 'Voir sur OpenAgenda';
                    links.appendChild(oaLink);
                }

                if (ev.latitude != null && ev.longitude != null) {
                    const gmapsLink = document.createElement('a');
                    gmapsLink.className = 'event-link';
                    gmapsLink.href = `https://www.google.com/maps?q=${ev.latitude},${ev.longitude}`;
                    gmapsLink.target = '_blank';
                    gmapsLink.rel = 'noopener noreferrer';
                    gmapsLink.textContent = 'Voir dans Google Maps';
                    links.appendChild(gmapsLink);
                }

                if (links.children.length > 0) {
                    li.appendChild(links);
                }

                list.appendChild(li);

                // Ajouter un marqueur sur la carte pour cet √©v√©nement
                if (ev.latitude != null && ev.longitude != null) {
                    const marker = L.marker([ev.latitude, ev.longitude]).addTo(eventsMap);

                    // Cr√©er le popup avec les infos de l'√©v√©nement
                    const popupContent = `
                        <div style="min-width: 200px;">
                            <strong style="font-size: 13px;">${ev.title}</strong><br>
                            <span style="font-size: 11px; color: #6b7280;">
                                ${whereParts.join(' ¬∑ ') || 'Lieu non pr√©cis√©'}<br>
                                ${ev.distanceKm != null ? ev.distanceKm + ' km' : ''}
                            </span><br>
                            ${ev.openagendaUrl ? `<a href="${ev.openagendaUrl}" target="_blank" rel="noopener noreferrer" style="font-size: 11px;">Voir sur OpenAgenda</a>` : ''}
                        </div>
                    `;
                    marker.bindPopup(popupContent);

                    eventsMarkers.push(marker);
                }
            });

            // Ajuster la vue de la carte pour montrer tous les marqueurs
            if (eventsMarkers.length > 0) {
                const group = L.featureGroup(eventsMarkers);
                eventsMap.fitBounds(group.getBounds().pad(0.1));
            }

            section.style.display = 'block';
            updateStatus(
                `üü¢ √âv√©nements charg√©s ${placeText} dans un rayon de ${radiusKm} km, du ${range.start} au ${range.end}.`,
                'active'
            );
        } catch (e) {
            console.error(e);
            updateStatus('üî¥ Erreur lors du chargement des √©v√©nements √† proximit√©', 'error');
        }
    }

    // üîπ planification de la mise √† jour apr√®s d√©placement des sliders
    function scheduleSliderUpdate() {
        if (!currentPosition) {
            return;
        }
        if (sliderUpdateTimeout) {
            clearTimeout(sliderUpdateTimeout);
        }
        sliderUpdateTimeout = setTimeout(() => {
            fetchNearbyEvents(currentPosition);
        }, SLIDER_DEBOUNCE_MS);
    }

    function setupSliders() {
        const radiusRange = document.getElementById('radiusRange');
        const daysRange = document.getElementById('daysRange');
        const radiusValue = document.getElementById('radiusValue');
        const daysValue = document.getElementById('daysValue');

        radiusRange.addEventListener('input', () => {
            currentRadiusKm = parseInt(radiusRange.value, 10);
            radiusValue.textContent = currentRadiusKm;
            scheduleSliderUpdate();
        });

        daysRange.addEventListener('input', () => {
            currentDays = parseInt(daysRange.value, 10);
            daysValue.textContent = currentDays;
            scheduleSliderUpdate();
        });
    }

    window.addEventListener('load', () => {
        setupSliders();
        initGeolocationOnLoad();
    });
</script>
</body>
</html>
