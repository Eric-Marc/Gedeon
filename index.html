<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Phone Location & Events</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 26px;
            margin-bottom: 6px;
            color: #111827;
        }

        .subtitle {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .status {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.waiting {
            background: #fef3c7;
            color: #92400e;
        }

        .status.active {
            background: #d1fae5;
            color: #065f46;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            flex: 1;
            min-width: 120px;
            border: none;
            border-radius: 10px;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary {
            background: #4f46e5;
            color: #ffffff;
        }

        .btn-primary:hover:not(:disabled) {
            background: #4338ca;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4);
        }

        .btn-secondary {
            background: #10b981;
            color: #ffffff;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: #ffffff;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }

        .section {
            background: #f9fafb;
            border-radius: 14px;
            padding: 15px 18px;
            margin-bottom: 15px;
        }

        .section h2 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #111827;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px 10px;
            font-size: 13px;
        }

        .info-label {
            color: #6b7280;
        }

        .info-value {
            color: #111827;
            font-family: monospace;
            text-align: right;
        }

        .map-container {
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .map-container iframe {
            width: 100%;
            height: 260px;
            border: 0;
        }

        .map-link {
            display: inline-block;
            margin-top: 6px;
            font-size: 13px;
            text-decoration: none;
            color: #4f46e5;
            font-weight: 500;
        }

        .map-link:hover {
            text-decoration: underline;
        }

        .events-list {
            list-style: none;
            margin-top: 10px;
        }

        .event-item {
            background: #ffffff;
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
        }

        .event-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #111827;
        }

        .event-meta {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .event-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 6px;
        }

        .event-link {
            font-size: 12px;
            text-decoration: none;
            color: #2563eb;
        }

        .event-link:hover {
            text-decoration: underline;
        }

        .event-map {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            margin-top: 4px;
        }

        .event-map iframe {
            width: 100%;
            height: 180px;
            border: 0;
        }

        .hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        @media (max-width: 640px) {
            .info-grid {
                grid-template-columns: 1fr;
                text-align: left;
            }
            .info-value {
                text-align: left;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üìç Suivi de position & √©v√©nements</h1>
    <p class="subtitle">
        Envoie la position de ton t√©l√©phone au serveur, puis affiche les √©v√©nements OpenAgenda
        dans un rayon de 30 km pour les deux jours √† venir, sur Google&nbsp;Maps.
    </p>

    <div id="status" class="status waiting">
        ‚è≥ En attente de d√©marrer le suivi‚Ä¶
    </div>

    <div class="button-group">
        <button id="startBtn" class="btn-primary" onclick="startTracking()">D√©marrer le suivi</button>
        <button id="stopBtn" class="btn-danger" onclick="stopTracking()" disabled>Arr√™ter le suivi</button>
    </div>

    <div class="button-group">
        <button class="btn-secondary" onclick="sendOnce()">Envoyer une seule fois</button>
        <button class="btn-secondary" onclick="fetchLatestLocation()">Dernier point</button>
        <button class="btn-secondary" onclick="fetchNearbyEvents()">√âv√©nements √† proximit√©</button>
    </div>

    <!-- Position actuelle -->
    <div class="section" id="currentLocationSection" style="display:none;">
        <h2>Position actuelle (t√©l√©phone)</h2>
        <div class="info-grid">
            <div class="info-label">Latitude</div>
            <div class="info-value" id="currentLatitude">-</div>
            <div class="info-label">Longitude</div>
            <div class="info-value" id="currentLongitude">-</div>
            <div class="info-label">Pr√©cision</div>
            <div class="info-value" id="currentAccuracy">-</div>
            <div class="info-label">Derni√®re mise √† jour</div>
            <div class="info-value" id="currentTimestamp">-</div>
        </div>
        <a id="currentMapLink" class="map-link" href="#" target="_blank" rel="noopener noreferrer">
            üìç Ouvrir cette position dans Google Maps
        </a>
    </div>

    <!-- Dernier point enregistr√© -->
    <div class="section" id="latestLocationSection" style="display:none;">
        <h2>Dernier point enregistr√©</h2>
        <div class="info-grid">
            <div class="info-label">Latitude</div>
            <div class="info-value" id="latestLatitude">-</div>
            <div class="info-label">Longitude</div>
            <div class="info-value" id="latestLongitude">-</div>
            <div class="info-label">Pr√©cision</div>
            <div class="info-value" id="latestAccuracy">-</div>
            <div class="info-label">Enregistr√© le</div>
            <div class="info-value" id="latestTimestamp">-</div>
        </div>
        <a id="latestMapLink" class="map-link" href="#" target="_blank" rel="noopener noreferrer">
            üìç Voir ce point dans Google Maps
        </a>
        <div class="map-container">
            <iframe id="latestMapFrame" loading="lazy" allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <p class="hint">
            Les √©v√©nements seront recherch√©s dans un rayon de 30 km autour de ce point.
        </p>
    </div>

    <!-- √âv√©nements √† proximit√© -->
    <div class="section" id="eventsSection" style="display:none;">
        <h2>√âv√©nements √† proximit√© (30 km, 2 jours)</h2>
        <p id="eventsEmpty" style="display:none; font-size:13px; color:#6b7280; margin-bottom:8px;">
            Aucun √©v√©nement trouv√© dans ce p√©rim√®tre pour les deux jours √† venir.
        </p>
        <ul id="eventsList" class="events-list"></ul>
        <p class="hint">
            Chaque √©v√©nement a son plan int√©gr√© ci-dessous via Google&nbsp;Maps (iframe)
            et un lien direct vers Google&nbsp;Maps.
        </p>
    </div>
</div>

<script>
    let watchId = null;
    let isTracking = false;
    const SERVER_URL = window.location.origin;

    function updateStatus(message, type) {
        const div = document.getElementById('status');
        div.textContent = message;
        div.className = 'status ' + type;
    }

    function updateCurrentLocationDisplay(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const acc = position.coords.accuracy;

        document.getElementById('currentLatitude').textContent = lat.toFixed(6);
        document.getElementById('currentLongitude').textContent = lon.toFixed(6);
        document.getElementById('currentAccuracy').textContent =
            acc != null ? Math.round(acc) + ' m' : '-';
        document.getElementById('currentTimestamp').textContent =
            new Date().toLocaleString();

        const mapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
        document.getElementById('currentMapLink').href = mapsUrl;

        document.getElementById('currentLocationSection').style.display = 'block';
    }

    async function sendLocation(position) {
        updateCurrentLocationDisplay(position);

        const data = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy
        };

        try {
            const res = await fetch(`${SERVER_URL}/api/location`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await res.json();
            if (res.ok && result.status === 'success') {
                updateStatus('üü¢ Position envoy√©e au serveur', 'active');
                // On met √† jour le dernier point affich√©
                fetchLatestLocation(false);
            } else {
                updateStatus('üî¥ Erreur lors de l\'envoi de la position', 'error');
                console.error(result);
            }
        } catch (e) {
            updateStatus('üî¥ Erreur r√©seau lors de l\'envoi de la position', 'error');
            console.error(e);
        }
    }

    function startTracking() {
        if (!navigator.geolocation) {
            updateStatus('üî¥ G√©olocalisation non support√©e par ce navigateur', 'error');
            return;
        }
        if (isTracking) return;

        isTracking = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        updateStatus('üü° D√©marrage du suivi de position‚Ä¶', 'active');

        watchId = navigator.geolocation.watchPosition(
            sendLocation,
            (error) => {
                console.error(error);
                updateStatus('üî¥ Erreur de g√©olocalisation : ' + error.message, 'error');
            },
            {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 10000
            }
        );
    }

    function stopTracking() {
        if (watchId != null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
        isTracking = false;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        updateStatus('‚è∏Ô∏è Suivi arr√™t√©', 'waiting');
    }

    function sendOnce() {
        if (!navigator.geolocation) {
            updateStatus('üî¥ G√©olocalisation non support√©e par ce navigateur', 'error');
            return;
        }
        updateStatus('üü° R√©cup√©ration de la position‚Ä¶', 'active');

        navigator.geolocation.getCurrentPosition(
            sendLocation,
            (error) => {
                console.error(error);
                updateStatus('üî¥ Erreur de g√©olocalisation : ' + error.message, 'error');
            },
            {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 10000
            }
        );
    }

    async function fetchLatestLocation(updateEvents = true) {
        try {
            const res = await fetch(`${SERVER_URL}/api/location/latest`);
            const result = await res.json();

            if (!res.ok || result.status !== 'success') {
                updateStatus('üü° Aucun point enregistr√© pour le moment', 'waiting');
                document.getElementById('latestLocationSection').style.display = 'none';
                return;
            }

            const loc = result.location;
            const lat = loc.latitude;
            const lon = loc.longitude;
            const acc = loc.accuracy;
            const ts = loc.timestamp;

            document.getElementById('latestLatitude').textContent = lat.toFixed(6);
            document.getElementById('latestLongitude').textContent = lon.toFixed(6);
            document.getElementById('latestAccuracy').textContent =
                acc != null ? Math.round(acc) + ' m' : '-';
            document.getElementById('latestTimestamp').textContent =
                ts ? new Date(ts).toLocaleString() : '-';

            const mapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
            document.getElementById('latestMapLink').href = mapsUrl;
            document.getElementById('latestMapFrame').src =
                `https://www.google.com/maps?q=${lat},${lon}&z=13&output=embed`;

            document.getElementById('latestLocationSection').style.display = 'block';
            updateStatus('üü¢ Dernier point charg√©', 'active');

            if (updateEvents) {
                // Optionnel : d√©clenche la recherche des √©v√©nements automatiquement
                // fetchNearbyEvents();
            }
        } catch (e) {
            console.error(e);
            updateStatus('üî¥ Erreur lors de la r√©cup√©ration du dernier point', 'error');
        }
    }

    async function fetchNearbyEvents() {
        try {
            updateStatus('üü° Chargement des √©v√©nements √† proximit√©‚Ä¶', 'active');

            const res = await fetch(`${SERVER_URL}/api/events/nearby`);
            const result = await res.json();

            const section = document.getElementById('eventsSection');
            const list = document.getElementById('eventsList');
            const empty = document.getElementById('eventsEmpty');

            list.innerHTML = '';
            empty.style.display = 'none';

            if (!res.ok || result.status !== 'success') {
                section.style.display = 'block';
                empty.textContent = result.message || 'Erreur lors de la r√©cup√©ration des √©v√©nements.';
                empty.style.display = 'block';
                updateStatus('üî¥ Impossible de r√©cup√©rer les √©v√©nements', 'error');
                return;
            }

            const events = result.events || [];
            if (events.length === 0) {
                section.style.display = 'block';
                empty.style.display = 'block';
                updateStatus('üü° Aucun √©v√©nement trouv√© dans les 30 km pour les 2 jours √† venir', 'waiting');
                return;
            }

            // Affiche les √©v√©nements, avec Google Maps int√©gr√© pour les 10 premiers
            events.forEach((ev, index) => {
                const li = document.createElement('li');
                li.className = 'event-item';

                const title = document.createElement('div');
                title.className = 'event-title';
                title.textContent = ev.title || '√âv√©nement sans titre';

                const meta = document.createElement('div');
                meta.className = 'event-meta';

                const begin = ev.begin ? new Date(ev.begin).toLocaleString() : 'Date non pr√©cis√©e';

                const whereParts = [];
                if (ev.locationName) whereParts.push(ev.locationName);
                if (ev.address) whereParts.push(ev.address);
                if (ev.city) whereParts.push(ev.city);

                meta.textContent = `${begin} ‚Äî ${whereParts.join(' ¬∑ ') || 'Lieu non pr√©cis√©'}`;

                li.appendChild(title);
                li.appendChild(meta);

                const links = document.createElement('div');
                links.className = 'event-links';

                if (ev.openagendaUrl) {
                    const oaLink = document.createElement('a');
                    oaLink.className = 'event-link';
                    oaLink.href = ev.openagendaUrl;
                    oaLink.target = '_blank';
                    oaLink.rel = 'noopener noreferrer';
                    oaLink.textContent = 'Voir sur OpenAgenda';
                    links.appendChild(oaLink);
                }

                if (ev.latitude != null && ev.longitude != null) {
                    const gmapsLink = document.createElement('a');
                    gmapsLink.className = 'event-link';
                    gmapsLink.href = `https://www.google.com/maps?q=${ev.latitude},${ev.longitude}`;
                    gmapsLink.target = '_blank';
                    gmapsLink.rel = 'noopener noreferrer';
                    gmapsLink.textContent = 'Voir dans Google Maps';
                    links.appendChild(gmapsLink);
                }

                if (links.children.length > 0) {
                    li.appendChild(links);
                }

                // Int√®gre une petite carte Google Maps (iframe) pour les premiers √©v√©nements
                if (ev.latitude != null && ev.longitude != null && index < 10) {
                    const mapDiv = document.createElement('div');
                    mapDiv.className = 'event-map';

                    const iframe = document.createElement('iframe');
                    iframe.loading = 'lazy';
                    iframe.allowFullscreen = true;
                    iframe.referrerPolicy = 'no-referrer-when-downgrade';
                    iframe.src = `https://www.google.com/maps?q=${ev.latitude},${ev.longitude}&z=14&output=embed`;

                    mapDiv.appendChild(iframe);
                    li.appendChild(mapDiv);
                }

                list.appendChild(li);
            });

            section.style.display = 'block';
            updateStatus('üü¢ √âv√©nements √† proximit√© charg√©s', 'active');
        } catch (e) {
            console.error(e);
            updateStatus('üî¥ Erreur lors du chargement des √©v√©nements √† proximit√©', 'error');
        }
    }

    // Au chargement de la page, on essaye d√©j√† de r√©cup√©rer le dernier point
    window.addEventListener('load', () => {
        fetchLatestLocation(false);
    });
</script>
</body>
</html>
