<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gedeon ‚Äî √âv√©nements & Cin√©mas</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f3f4f6;
            color: #111827;
        }

        #header {
            background: linear-gradient(90deg, #4f46e5, #6366f1);
            color: white;
            padding: 12px 18px;
            box-shadow: 0 2px 4px rgba(15, 23, 42, 0.25);
        }

        #header h1 {
            margin: 0;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #header p {
            margin: 4px 0 0 0;
            font-size: 13px;
            opacity: 0.95;
        }

        #controls {
            padding: 10px 18px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }

        button {
            border: none;
            background: #4f46e5;
            color: white;
            border-radius: 9999px;
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.35);
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s;
        }

        button:hover:not(:disabled) {
            background: #4338ca;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(79, 70, 229, 0.3);
        }

        button:disabled {
            background: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: white;
            border-radius: 9999px;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
        }

        .slider-label {
            font-size: 12px;
            color: #374151;
            font-weight: 500;
        }

        .slider-value {
            font-size: 12px;
            color: #111827;
            min-width: 70px;
        }

        input[type="range"] {
            accent-color: #4f46e5;
        }

        #status {
            padding: 7px 12px;
            border-radius: 9999px;
            font-size: 12px;
            background: #e5e7eb;
            color: #374151;
            min-width: 230px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
        }

        .status.waiting  { background: #e5e7eb; color: #374151; }
        .status.active   { background: #d1fae5; color: #065f46; }
        .status.error    { background: #fee2e2; color: #991b1b; }
        .status.loading  { animation: blinkStatus 1s ease-in-out infinite; }

        @keyframes blinkStatus {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%      { opacity: 0.6; transform: scale(0.98); }
        }

        #stats {
            background: white;
            padding: 8px 18px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            align-items: center;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-icon {
            font-size: 20px;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #6b7280;
        }

        .stat-value {
            font-size: 13px;
            font-weight: 600;
            color: #111827;
        }

        #map-container {
            position: relative;
            height: calc(100vh - 185px);
        }

        #map {
            height: 100%;
            width: 100%;
            background: #e5e7eb;
        }

        #map-instructions {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 9999px;
            font-size: 12px;
            box-shadow: 0 3px 8px rgba(15, 23, 42, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.3s ease;
        }

        #map-instructions.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .center-marker {
            border-radius: 9999px;
        }

        .event-popup {
            font-size: 13px;
            max-width: 260px;
        }

        .event-popup h3 {
            margin: 0 0 4px 0;
            font-size: 14px;
        }

        .event-popup .date {
            font-size: 12px;
            color: #374151;
        }

        .event-popup .venue {
            margin-top: 4px;
            font-weight: 500;
            color: #111827;
        }

        .event-popup .address {
            font-size: 12px;
            color: #4b5563;
        }

        .event-popup .distance {
            margin-top: 4px;
            font-size: 12px;
            color: #6b7280;
        }

        .event-popup a.link {
            display: inline-block;
            margin-top: 6px;
            font-size: 12px;
            color: #4f46e5;
            text-decoration: none;
        }

        .event-popup a.link:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            #header h1 { font-size: 20px; }
            #header p  { font-size: 12px; }
            #controls  { padding: 8px 12px; }
            .control-group { flex-direction: column; align-items: stretch; }
            button { width: 100%; justify-content: center; }
            .slider-group { width: 100%; justify-content: space-between; }
            #map-container { height: calc(100vh - 235px); }
        }
    </style>
</head>
<body>
<div id="header">
    <h1>üóìÔ∏è Gedeon ‚Äî √âv√©nements & Cin√©mas</h1>
    <p>Maintenez appuy√© 2 secondes sur la carte pour choisir un point de recherche</p>
</div>

<div id="controls">
    <div class="control-group">
        <button id="btnMyPosition" onclick="getUserLocation()">üìç Ma position</button>
        <button id="btnCinemas" onclick="searchNearbyCinemas()" disabled>üé¨ Cin√©mas dans ce rayon</button>

        <div class="slider-group">
            <span class="slider-label">Rayon :</span>
            <input type="range" id="radiusRange" min="5" max="100" value="30" step="5">
            <span class="slider-value"><span id="radiusValue">30</span> km</span>
        </div>

        <div class="slider-group">
            <span class="slider-label">P√©riode :</span>
            <input type="range" id="daysRange" min="1" max="30" value="7" step="1">
            <span class="slider-value"><span id="daysValue">7</span> jours</span>
        </div>

        <div id="status" class="status waiting">üëÜ Long press (2s) sur la carte pour choisir un point</div>
    </div>
</div>

<div id="stats">
    <div class="stat">
        <span class="stat-icon">üìç</span>
        <div>
            <div class="stat-label">Position</div>
            <div class="stat-value" id="eventsPosition">Aucune</div>
        </div>
    </div>
    <div class="stat">
        <span class="stat-icon">üé´</span>
        <div>
            <div class="stat-label">√âv√©nements</div>
            <div class="stat-value" id="eventsCount">0</div>
        </div>
    </div>
    <div class="stat">
        <span class="stat-icon">üèüÔ∏è</span>
        <div>
            <div class="stat-label">Lieux</div>
            <div class="stat-value" id="eventsVenues">0</div>
        </div>
    </div>
    <div class="stat">
        <span class="stat-icon">üìö</span>
        <div>
            <div class="stat-label">Agendas</div>
            <div class="stat-value" id="eventsAgendas">0</div>
        </div>
    </div>
</div>

<div id="map-container">
    <div id="map"></div>
    <div id="map-instructions">üëÜ Maintenez appuy√© 2 secondes sur la carte</div>
</div>

<script>
    const SERVER_URL = window.location.origin;

    const LONGPRESS_DURATION   = 2000; // ms
    const DRAG_DISTANCE_MAX_M  = 150;  // distance max autoris√©e pendant long press

    // √âtat global
    let map = null;
    let currentMarkerCluster = null;
    let currentPosition = null;
    let currentRadiusKm = 30;
    let currentDays = 7;
    let currentContextLabel = '';
    let currentFetchController = null;
    let currentRadiusCircle = null;
    let currentCenterMarker = null;
    let cinemaLayer = null;
    let clearOldSearchTimer = null;

    // √âtat long press (en coordonn√©es g√©ographiques)
    const lpState = {
        active: false,
        startTime: 0,
        startLatLng: null,
        timerId: null
    };

    // ---------- UTIL UI ----------

    function updateStatus(message, type = 'waiting') {
        const el = document.getElementById('status');
        el.textContent = message;
        el.className = 'status ' + type;
        if (type === 'active' && message.includes('üîç')) {
            el.classList.add('loading');
        }
    }

    function updateStats(events) {
        const venues = {};
        const agendas = {};
        events.forEach(ev => {
            if (ev.locationName) venues[ev.locationName] = true;
            if (ev.agendaTitle)  agendas[ev.agendaTitle] = true;
        });
        document.getElementById('eventsCount').textContent   = events.length;
        document.getElementById('eventsVenues').textContent  = Object.keys(venues).length;
        document.getElementById('eventsAgendas').textContent = Object.keys(agendas).length;
    }

    function formatDate(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.toLocaleString('fr-FR', {
            weekday: 'short',
            day: '2-digit',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ---------- CARTE + LONG PRESS ----------

    function initMap() {
        map = L.map('map', {
            center: [46.603354, 1.888334],
            zoom: 6,
            tap: true,
            tapTolerance: 15
        });

        L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap France & OpenStreetMap'
        }).addTo(map);

        setupLongPress();
    }

    function setupLongPress() {
        // Desktop
        map.on('mousedown', (e) => {
            if (e.originalEvent && e.originalEvent.button !== undefined &&
                e.originalEvent.button !== 0) {
                return; // seulement bouton gauche
            }
            startLongPress(e.latlng);
        });

        map.on('mousemove', (e) => {
            moveLongPress(e.latlng);
        });

        map.on('mouseup', () => {
            endLongPress();
        });

        // Mobile
        map.on('touchstart', (e) => {
            const first = (e.latlng || (e.latlngs && e.latlngs[0]));
            if (!first) return;
            startLongPress(first);
        });

        map.on('touchmove', (e) => {
            const first = (e.latlng || (e.latlngs && e.latlngs[0]));
            if (!first) return;
            moveLongPress(first);
        });

        map.on('touchend', () => {
            endLongPress();
        });

        map.on('touchcancel', () => {
            cancelLongPress();
        });
    }

    function startLongPress(latlng) {
        cancelLongPress();

        lpState.active = true;
        lpState.startTime = performance.now();
        lpState.startLatLng = latlng;

        lpState.timerId = setTimeout(() => {
            // Si on est encore actif et qu'on n'a pas trop boug√© ‚Üí long press valid√©
            if (!lpState.active || !lpState.startLatLng) return;
            const lat = lpState.startLatLng.lat;
            const lon = lpState.startLatLng.lng;
            cancelLongPress();
            document.getElementById('map-instructions').classList.add('hidden');
            onLocationSelected(lat, lon);
        }, LONGPRESS_DURATION);
    }

    function moveLongPress(currentLatLng) {
        if (!lpState.active || !lpState.startLatLng) return;
        // Distance en m√®tres entre le point de d√©part et le point actuel
        const d = map.distance(lpState.startLatLng, currentLatLng);
        if (d > DRAG_DISTANCE_MAX_M) {
            // L'utilisateur pan la carte ‚Üí on annule le long press
            cancelLongPress();
        }
    }

    function endLongPress() {
        if (!lpState.active) return;
        // Si le timer ne s'est pas d√©clench√© ‚Üí pas assez long
        cancelLongPress();
    }

    function cancelLongPress() {
        if (lpState.timerId) {
            clearTimeout(lpState.timerId);
            lpState.timerId = null;
        }
        lpState.active = false;
        lpState.startLatLng = null;
    }

    function clearOldSearch() {
        if (currentMarkerCluster) {
            map.removeLayer(currentMarkerCluster);
            currentMarkerCluster = null;
        }
        if (currentRadiusCircle) {
            map.removeLayer(currentRadiusCircle);
            currentRadiusCircle = null;
        }
        if (currentCenterMarker) {
            map.removeLayer(currentCenterMarker);
            currentCenterMarker = null;
        }
        if (cinemaLayer) {
            map.removeLayer(cinemaLayer);
            cinemaLayer = null;
        }
        updateStats([]);
    }

    // ---------- POSITION / G√âOCODAGE ----------

    function getUserLocation() {
        if (!navigator.geolocation) {
            updateStatus('‚ùå G√©olocalisation non support√©e', 'error');
            return;
        }

        clearOldSearch();
        updateStatus('üîç Recherche de votre position‚Ä¶', 'active');

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                map.setView([lat, lon], 11);
                document.getElementById('map-instructions').classList.add('hidden');
                onLocationSelected(lat, lon);
            },
            (err) => {
                let msg = '‚ùå ';
                switch (err.code) {
                    case err.PERMISSION_DENIED:
                        msg += 'Permission refus√©e (activez la localisation)';
                        break;
                    case err.POSITION_UNAVAILABLE:
                        msg += 'Position non disponible';
                        break;
                    case err.TIMEOUT:
                        msg += 'D√©lai d√©pass√©';
                        break;
                    default:
                        msg += 'Erreur de g√©olocalisation';
                }
                updateStatus(msg, 'error');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }

    function getCityFromCoordinates(lat, lon) {
        const url = 'https://nominatim.openstreetmap.org/reverse?format=json&lat='
            + lat + '&lon=' + lon + '&zoom=12&addressdetails=1';

        return fetch(url, {
            headers: { 'User-Agent': 'gedeon-demo/1.0' }
        })
            .then(res => res.json())
            .then(data => {
                if (!data) return null;
                const addr = data.address || {};
                const city = addr.city || addr.town || addr.village ||
                             addr.municipality || addr.county || addr.state;
                return {
                    city: city || null,
                    country: addr.country || null
                };
            })
            .catch(() => null);
    }

    function onLocationSelected(lat, lon) {
        // Filtre simple France m√©tropolitaine
        const isInFrance = (lat >= 41 && lat <= 51) && (lon >= -5 && lon <= 10);
        if (!isInFrance) {
            updateStatus('‚ö†Ô∏è Position hors France m√©tropolitaine', 'error');
            return;
        }

        updateStatus('üîç Recherche de la localisation‚Ä¶', 'active');

        getCityFromCoordinates(lat, lon).then(info => {
            if (info && info.city) {
                currentContextLabel = '√† ' + info.city;
                document.getElementById('eventsPosition').textContent =
                    info.city + (info.country ? ', ' + info.country : '');
            } else {
                currentContextLabel = '√† cette position';
                document.getElementById('eventsPosition').textContent = 'Position choisie';
            }

            if (clearOldSearchTimer) {
                clearTimeout(clearOldSearchTimer);
            }
            clearOldSearchTimer = setTimeout(clearOldSearch, 90 * 60 * 1000);

            currentPosition = { coords: { latitude: lat, longitude: lon } };
            const cinemaBtn = document.getElementById('btnCinemas');
            if (cinemaBtn) cinemaBtn.disabled = false;

            fetchNearbyEvents(currentPosition);
        });
    }

    // ---------- √âV√âNEMENTS (OpenAgenda) ----------

    function displayEventsOnMap(events, centerLat, centerLon, radiusKm) {
        if (currentMarkerCluster) map.removeLayer(currentMarkerCluster);
        if (currentRadiusCircle) map.removeLayer(currentRadiusCircle);
        if (currentCenterMarker) map.removeLayer(currentCenterMarker);

        currentMarkerCluster = L.markerClusterGroup({
            chunkedLoading: true,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });

        if (centerLat != null && centerLon != null && radiusKm != null) {
            currentRadiusCircle = L.circle([centerLat, centerLon], {
                radius: radiusKm * 1000,
                color: '#667eea',
                fillColor: '#667eea',
                fillOpacity: 0.1,
                weight: 2,
                dashArray: '5, 10',
                interactive: false
            }).addTo(map);

            currentCenterMarker = L.marker([centerLat, centerLon], {
                icon: L.divIcon({
                    className: 'center-marker',
                    html: '<div style="background:#ef4444;width:16px;height:16px;border-radius:9999px;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.35);"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                })
            }).addTo(map).bindPopup('<strong>üìç Point de recherche</strong>');
        }

        events.forEach(ev => {
            if (!ev.latitude || !ev.longitude) return;
            const marker = L.marker([ev.latitude, ev.longitude]);
            let html = '<div class="event-popup">';
            html += '<h3>' + (ev.title || '√âv√©nement sans titre') + '</h3>';
            if (ev.begin) html += '<div class="date">üìÖ ' + formatDate(ev.begin) + '</div>';
            if (ev.locationName) html += '<div class="venue"><strong>üìç</strong> ' + ev.locationName + '</div>';
            if (ev.address) html += '<div class="address">' + ev.address + (ev.city ? ', ' + ev.city : '') + '</div>';
            if (ev.distanceKm != null) html += '<div class="distance">üìè ' + ev.distanceKm + ' km</div>';
            if (ev.agendaTitle) html += '<div class="address">üìö ' + ev.agendaTitle + '</div>';
            if (ev.openagendaUrl) {
                html += '<a href="' + ev.openagendaUrl + '" target="_blank" class="link">Voir les d√©tails ‚Üí</a>';
            }
            html += '</div>';
            marker.bindPopup(html, { maxWidth: 320 });
            currentMarkerCluster.addLayer(marker);
        });

        map.addLayer(currentMarkerCluster);

        if (currentRadiusCircle) {
            map.fitBounds(currentRadiusCircle.getBounds().pad(0.1));
        }

        updateStats(events);
    }

    function fetchNearbyEvents(position) {
        if (!position || !position.coords) {
            updateStatus('‚ùå Position invalide', 'error');
            return;
        }

        if (currentFetchController) currentFetchController.abort();
        currentFetchController = new AbortController();

        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const placeText = currentContextLabel || '√† proximit√©';

        updateStatus('üîç Connexion au serveur‚Ä¶', 'active');

        const url = SERVER_URL + '/api/events/nearby?lat=' + lat +
            '&lon=' + lon + '&radiusKm=' + currentRadiusKm + '&days=' + currentDays;

        const timeoutId = setTimeout(() => {
            currentFetchController.abort();
        }, 90000);

        updateStatus('üîç Recherche ' + placeText +
            ' (' + currentRadiusKm + ' km, ' + currentDays + ' j)‚Ä¶', 'active');

        fetch(url, { signal: currentFetchController.signal })
            .then(res => {
                clearTimeout(timeoutId);
                return res.json();
            })
            .then(result => {
                if (result.status !== 'success') {
                    updateStatus('‚ùå ' + (result.message || 'Erreur'), 'error');
                    return;
                }
                const events = result.events || [];
                if (events.length === 0) {
                    updateStatus('üîç Aucun √©v√©nement ' + placeText, 'waiting');
                    displayEventsOnMap([], lat, lon, currentRadiusKm);
                    return;
                }
                displayEventsOnMap(events, lat, lon, currentRadiusKm);
                updateStatus('‚úÖ ' + events.length + ' √©v√©nement(s) ' + placeText, 'active');
            })
            .catch(e => {
                if (e.name === 'AbortError') return;
                console.error(e);
                updateStatus('‚ùå Erreur de connexion: ' + e.message, 'error');
            });
    }

    // ---------- CIN√âMAS (OSM + Allocin√©) ----------

    function displayCinemasOnMap(cinemas) {
        if (!map) return;
        if (cinemaLayer) {
            map.removeLayer(cinemaLayer);
            cinemaLayer = null;
        }
        if (!cinemas || cinemas.length === 0) return;

        cinemaLayer = L.layerGroup();

        cinemas.forEach(cinema => {
            if (!cinema.latitude || !cinema.longitude) return;

            const marker = L.marker([cinema.latitude, cinema.longitude], {
                icon: L.divIcon({
                    className: 'cinema-marker',
                    html: '<div style="background:#f97316;width:18px;height:18px;border-radius:50%;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-size:12px;color:white;">üé¨</div>',
                    iconSize: [18, 18],
                    iconAnchor: [9, 9]
                })
            });

            let html = '<div class="event-popup">';
            html += '<h3>' + (cinema.name || 'Cin√©ma') + '</h3>';

            if (cinema.address) {
                html += '<div class="address">' + cinema.address + '</div>';
            } else if (cinema.city) {
                html += '<div class="address">' + cinema.city + '</div>';
            }
            if (cinema.distanceKm != null) {
                html += '<div class="distance">üìè ' + cinema.distanceKm + ' km</div>';
            }

            const showtimes = cinema.showtimes || [];
            if (showtimes.length > 0) {
                const dateLabel = cinema.showtimesDate || '';
                html += '<div style="margin-top:6px;font-size:12px;"><strong>üìÖ S√©ances ' +
                    dateLabel + '</strong><ul style="padding-left:18px;margin-top:4px;">';
                showtimes.forEach(film => {
                    const vf   = (film.vf   && film.vf.length)   ? 'VF: '   + film.vf.join(', ')   : null;
                    const vo   = (film.vo   && film.vo.length)   ? 'VO: '   + film.vo.join(', ')   : null;
                    const vost = (film.vost && film.vost.length) ? 'VOST: ' + film.vost.join(', ') : null;
                    const parts = [vf, vo, vost].filter(Boolean);
                    html += '<li><strong>' + (film.title || 'Film') + '</strong>';
                    if (film.duration) html += ' (' + film.duration + ')';
                    if (parts.length) html += ' ‚Äì ' + parts.join(' / ');
                    html += '</li>';
                });
                html += '</ul></div>';
            } else {
                html += '<div style="margin-top:6px;font-size:12px;">üîç S√©ances indisponibles pour ce cin√©ma.</div>';
            }

            html += '</div>';
            marker.bindPopup(html, { maxWidth: 320 });
            cinemaLayer.addLayer(marker);
        });

        cinemaLayer.addTo(map);
    }

    function searchNearbyCinemas() {
        if (!currentPosition) {
            updateStatus('‚ùå Aucun point s√©lectionn√© pour chercher des cin√©mas', 'error');
            return;
        }

        const lat = currentPosition.coords.latitude;
        const lon = currentPosition.coords.longitude;
        const placeText = currentContextLabel || 'autour du point';

        updateStatus('üîç Recherche des cin√©mas ' + placeText + '‚Ä¶', 'active');

        const url = SERVER_URL + '/api/cinemas?lat=' + lat + '&lon=' + lon +
            '&radiusKm=' + currentRadiusKm + '&withShowtimes=1';

        fetch(url)
            .then(res => res.json())
            .then(result => {
                if (result.status !== 'success') {
                    updateStatus('‚ùå ' + (result.message || 'Erreur lors de la recherche de cin√©mas'), 'error');
                    return;
                }

                const cinemas = result.cinemas || [];
                displayCinemasOnMap(cinemas);

                if (cinemas.length === 0) {
                    updateStatus('üîç Aucun cin√©ma ' + placeText, 'waiting');
                } else {
                    updateStatus('‚úÖ ' + cinemas.length + ' cin√©ma(s) ' + placeText, 'active');
                }
            })
            .catch(e => {
                console.error('Erreur cin√©mas:', e);
                updateStatus('‚ùå Erreur cin√©mas: ' + e.message, 'error');
            });
    }

    // ---------- SLIDERS ----------

    function setupSliders() {
        const radiusRange = document.getElementById('radiusRange');
        const radiusValue = document.getElementById('radiusValue');
        const daysRange   = document.getElementById('daysRange');
        const daysValue   = document.getElementById('daysValue');

        radiusRange.addEventListener('input', () => {
            radiusValue.textContent = radiusRange.value;
            currentRadiusKm = parseInt(radiusRange.value, 10);
            if (currentRadiusCircle) currentRadiusCircle.setRadius(currentRadiusKm * 1000);
        });

        daysRange.addEventListener('input', () => {
            daysValue.textContent = daysRange.value;
            currentDays = parseInt(daysRange.value, 10);
        });

        radiusRange.addEventListener('change', () => {
            if (currentPosition) fetchNearbyEvents(currentPosition);
        });

        daysRange.addEventListener('change', () => {
            if (currentPosition) fetchNearbyEvents(currentPosition);
        });
    }

    // ---------- INIT ----------

    window.addEventListener('load', () => {
        initMap();
        setupSliders();
        updateStatus('üëÜ Long press (2s) sur la carte pour choisir un point', 'waiting');
    });
</script>
</body>
</html>
